.. vim: syntax=rst

步进电机
==========================================

介绍
------------------

步进电机又称为脉冲电机,基于最基本的电磁铁原理,它是一种可以自由回转的电磁铁,其动作原理是依靠气隙磁导的变化来产生电磁转矩。
由于步进电机是一个可以把电脉冲转换成机械运动的装置,具有很好的数据控制特性,因此,计算机成为步进电机的理想驱动源,随着微电子
和计算机技术的发展,软硬件结合的控制方式成为了主流,即通过程序产生控制脉冲,驱动硬件电路。单片机通过软件来控制步进电机,更好地
挖掘出了电机的潜力。在不超载的情况下电机的转速和停止位置只取决于脉冲信号的频率和数量；并且步进电机的脉冲与步进旋转的角度成正比，
脉冲的频率与步进的转速成正比，所以可以很好的从源头控制信号的输出；且步进电机只有周期性的误差，使得在速度、
位置等控制领域用步进电机来控制变的非常的简单。即使这样想要玩转步进也不是件容易的事情。

.. image:: ../media/step_motor_pic.png
   :align: center

混合式步进电机拆解图

工作原理
------------------

通常电机的转子为永磁体，当电流流过定子绕组时，定子绕组产生一矢量磁场。磁场会带动转子旋转一定的角度，使得转子的一对磁场方向与定
子的磁场方向一致。当定子的矢量磁场旋转一个角度。转子也随着该磁场转步距角。每输入一个电脉冲，电动机转动一个角度前进一步。
它输出的角位移与输入的脉冲数成正比、转速与脉冲频率成正比。改变绕组通电的顺序，电机就会反转。所以可用控制脉冲数量、频率及电动
机各相绕组的通电顺序来控制步进电机的转动。具体看下图：

.. image:: ../media/step_dingzi.png
   :align: center

步进电机横截图


步进电机极性区分
^^^^^^^^^^^^^^^^^^^^^

步进电机又分为单极性的步进电机和双极性的步进电机；具体简易图如下图所示：

.. image:: ../media/单双极性示意图.png
   :align: center
   
其中左侧为单极性步进电机，右侧为双极性的步进电机，从上图中不难看出区别是什么。单双极性是指一个步进电机里面有几种电流的流向，左侧
的五线四相步进电机就是单极性的步进电机，图中的红色箭头为电流的走向，四根线的电流走向汇总到公共线，所以称之为单极性电机；但是右侧则不同，
电机中有两个电流的回路，两个电流的回路自然就是双极性，所以称之为双极性电机。

**单极性绕组**

单极性步进电机使用的是单极性绕组。其一个电极上有两个绕组，这种联接方式为当一个绕组通电时，产生一个北极磁场；另一个绕组通电，则产生一个南极磁场。
因为从驱动器到线圈的电流不会反向，所以可称其为单极绕组。

**双极性绕组**

双极性步进电机使用的是双极性绕组。每相用一个绕组，通过将绕组中电流反向，电磁极性被反向。典型的两相双极驱动的输出步骤在电气
原理图和下图中的步进顺序中进一步阐述。按图所示，转换只利用绕组简单地改变电流的方向，就能改变该组的极性。



.. image:: ../media/磁场极性.png
   :align: center

永磁步进电机包括一个永磁转子、线圈绕组和导磁定子，只要将线圈通电根据电磁铁的原理就会产生磁场，分为南北极，见上图所示；通过改变步进电机定子
的磁场，转子就会因磁场的变化而发生转动，同理，依次改变通电的顺序就可以使得电机转动起来。

双极性步进电机驱动原理
^^^^^^^^^^^^^^^^^^^^^

下图是一个双极性的步进电机整步，步进顺序。在第一步中：将A相通电，根据电磁铁原理，产生磁性，并且因异性相吸，所以磁场将转子固定在第一步的位置；
第二步：当A相关闭，B相通电时，转子会旋转90°；第三步：B相关闭、A相通电，但极性与第1步相反，这促使转子再次旋转90°。在第4步中，A相关闭、B相通电，极性与第2
步相反。重复该顺序促使转子按90°的步距角顺时针旋转。

.. image:: ../media/双极性整步.png
   :align: center

上图中显示的步进顺序是单相激励步进，也可以理解为每次通电产生磁性的相只有一个，要么A相，要么B相；但是更常用的是双相激励，但是在转换时，一次只能换相一次，
具体详见下图：


.. image:: ../media/双极性半步.png
   :align: center

上图是两相同时通电的旋转顺序，与单相激励不同的是，单相通电后被固定在了与定子正对着的绕组极性，但是双相同时激励时转子却被固定在两个绕阻的极性中间；
此时通电顺序就变成了AB相同时通电即可。

在双相激励的过程中，也可以在装换相位时加一个关闭相位的状态而产生走半步的现象，这将步进电机的整个步距角一分为二，例如，一个90°的步进电机将每半步移动45°，
具体见下图。

.. image:: ../media/双相激励-带半步.png
   :align: center   

1. A相通电，B相不通电
#. A、B相全部通电，且电流相同，产生相同磁性
#. B相通电，A断电
#. B相通电，A相通电，且电流相等，产生相同磁性

#. A相通电，B断电
#. A、B相全部通电，且电流相同，产生相同磁性
#. B相通电，A断电
#. B相通电，A相通电，且电流相等，产生相同磁性

其中1~4步与5~8步的电流方向相反（电流相反，电磁的极性就相反）这样就产生了顺时针旋转，同理逆时针是
将通电顺序反过来即可。


单极性步进电机驱动原理
^^^^^^^^^^^^^^^^^^^^^
单极性与双极性步进电机驱动类似，都可以分为整步与半步的驱动方式，不同的是，双极性的步进电机可以通过改变
电流的方向来改变每相的磁场方向，但是单极性的就不可以了，它有一个公共端，这就直接决定了，电流方向。具体旋转顺序详见下图：

.. image:: ../media/单极性整步.png
   :align: center  

上图是单极性步进电机整步旋转的过程，其中，在图示中分为5根线，分别为A、B、C、D和公共端（+），公共端需要一直通电，剩下
ABCD相中只要有一个相通电，即可形成回路产生磁场，图中的通电顺序为A->B->C->D,即可完成上图中的顺时针旋转，如果想要逆时针旋转
只需要将其倒序即可。

以上是单相通电产生的整步旋转，两相通电也可以产生，两个相邻的相通电，这样相邻的两个相就都产生了回路，也就产生了磁场，
图中的通电顺序为AB->BC->CD->DA,同理逆时针旋转的顺序为逆序。具体看下图：

.. image:: ../media/单极性半步.png
   :align: center  

上面两张图清晰的描述了单极性步进电机的通电顺序与旋转的过程，综合这两张图就是单极性步进电机半步的通电顺序，具体看下图：

.. image:: ../media/单极性整步+半步.png
   :align: center     

上图兼容了前两张图的所有特点，也可以说前两张图是这张图的子集，图中的通电顺序为：A->AB->B->BC->C->CD->D->DA
转子每次只走半步45度，所以这也被称为半步驱动，与整步相比半步的旋转方式旋转起来更加的顺滑。


细分器驱动原理
^^^^^^^^^^^^^^^^^^^^^
对于细分驱动的原理，不分单双极步进电机，下图以单极为例：

.. image:: ../media/电流细分原理.png
   :align: center   

在上图中均为双相激励；其中图（a）为A相电流很大，B相的电流极其微弱，接近0；图(C)为A相和B相的电流相同，电流决定磁场，所以说
A相和B相的磁场也是相同的，(a)和（c）可以是极限特殊的情况，再看图（b）和图（d）这两个是由于A相和B相的电流不同产生位置情况；
由此可以得出改变定子的电流比例就可以使得转子在任意角度停住。细分的原理就是：通过改变定子的电流比例，改变转子在一个整步中的
不同位置，可以将一个整步分成多个小步来运行。

在上图中就是一个整步分成了4步来跑，从（a）~（d）是A相的电流逐渐减小，B相电流逐渐增大的过程，如果驱动器的细分能力很强，可以将其
分成32细分、64细分等；这不仅提高了步进电机旋转的顺畅度而且提高了每步的精度。


技术指标术语
------------------


静态指标术语
^^^^^^^^^^^^^^^^^^^^^

- 相数：产生不同对极N、S磁场的激磁线圈对数，也可以理解为步进电机中线圈的组数，其中两相步进电机步距角为1.8°，三相的步进电机步距角为1.5°，
  相数越多的步进电机，其步距角就越小。
- 拍数：完成一个磁场周期性变化所需脉冲数或导电状态用n表示，或指电机转过一个齿距角所需脉冲数，以四相电机为例，
  有四相四拍运行方式即AB-BC-CD-DA-AB，四相八拍运行方式即 A-AB-B-BC-C-CD-D-DA-A。
- 步距角：一个脉冲信号所对应的电机转动的角度，可以简单理解为一个脉冲信号驱动的角度，电机上都有写，一般42步进电机的步距角为1.8°
- 定位转矩：电机在不通电状态下，电机转子自身的锁定力矩（由磁场齿形的谐波以及机械误差造成的）。
- 静转矩：电机在额定静态电压作用下，电机不作旋转运动时，电机转轴的锁定力矩。此力矩是衡量电机体积的标准，与驱动电压及驱动电源等无关。 
  

动态指标术语
^^^^^^^^^^^^^^^^^^^^^

- 步距角精度：步进电机转动一个步距角度的理论值与实际值的误差。用百分比表示：误差/步距角*100%。
- 失步：电机运转时运转的步数，不等于理论上的步数。也可以叫做丢步，一般都是因负载太大或者是频率过快。
- 失调角：转子齿轴线偏移定子齿轴线的角度，电机运转必存在失调角，由失调角产生的误差，采用细分驱动是不能解决的。
- 最大空载起动频率：在不加负载的情况下，能够直接起动的最大频率。
- 最大空载的运行频率：电机不带负载的最高转速频率。
- 运行转矩特性：电机的动态力矩取决于电机运行时的平均电流（而非静态电流），平均电流越大，电机输出力矩越大，即电机的频率特性越硬。
- 电机正反转控制：通过改变通电顺序而改变电机的正反转。



主要特点
------------------

1. 步进电机的精度大概为步距角的3-5%，且不会积累
#. 步进电机的外表允许的最高温度：一般步进电机会因外表温度过高而产生磁性减小，从而会导致力矩较小，一般来说磁性材料的退
   磁点都在摄氏130度以上，有的甚至高达摄氏200度以上，所以步进电机外表温度在摄氏80-90度完全正常。
#. 步进电机的转矩与速度成反比，速度越快力矩越小。
#. 低速时步进电机可以正常启动，高速时不会启动，并伴有啸叫声。步进电机的空载启动频率是固定的，如果高于这个频率电机不能被启动
   并且会产生丢步或者堵转。

驱动器简介
------------------

步进电机必须要有控制器和驱动器才可以使电机正常工作，控制器是stm32或者其它型号的MCU了，驱动器就是步进电机驱动器了。
为什么要使用驱动器呢？驱动器起到将控制器信号放大或者转换的作用，如下图所示，控制器输出方向信号和脉冲信号来控制步进电机驱动器，
驱动器将其功率放大然后作用到步进电机上。

.. image:: ../media/xifenqi.png
   :align: center

野火步进电机细分器介绍
^^^^^^^^^^^^^^^^^^^^^

BHMSD4805是野火科技推出的一款智能步进电机驱动器。它是一款以双极恒流PWM驱动输出控制电机的驱动器，驱动电压范围
DC12V~48V,适合外径为42mm、 57mm、86mm系列，驱动电流在5A以下的所有两相混合式步进电机。
根据驱动器提供的8位拨码开关可以轻松的实现对不同电机电流及不同细分步数的精确控制。带有自动半流技术，
可以大大降低电机的功耗及发热量，输入信号都经过光耦隔离，具有很强的抗干扰能力，能适应恶劣的工作环境，下图为产品实物图。

.. image:: ../media/step_xifen.png
   :align: center

**驱动器性能表**

========  ============================
 参数      说明
========  ============================
额定电压    直流： 12V~48V
额定电流    0.75A~5.0A
驱动方式    双极恒流PWM驱动输出
工作温度    0℃~80℃
结构尺寸    118*75.5*33 单位mm
应用领域    数控设备、雕刻机等设备
========  ============================

模块引脚说明
^^^^^^^^^^^^^^^^^^^^^

驱动器右侧分别是电源及故障指示灯、控制信号接口、参数设定拨码开关、电源驱动接口，在其端子的正，上方是对应引脚名称的丝印。

控制信号引脚如下表所示：

======  =========== =================
 序号      引脚名称     引脚定义
======  =========== =================
1        ENA-(ENA)      输出使能负端
2        ENA+(5V)       输出使能正端
3        DIR-(DIR)      方向控制负端
4        DIR+(5V)       方向控制正端
5        PUL-(PLU)      脉冲控制负端
6        PUL+(5V)       脉冲控制正端
======  =========== =================

- ENA功能说明：控制器的输出是通过该组信号使能，又称脱机信号。当此信号有效时，输出关闭，电机绕组电流为零，
  电机为无力矩状态，可以自由转动电机，适合需要手动调整电机的场合。
- DIR功能说明：电机的方向控制信号，当此信号有效时，电机顺时针转动，当此信号无效时，电机逆时针旋转。
- PUL功能说明：电机的转动控制信号，驱动器接收到的脉冲信号电机就会按照既定的方向旋转。电机的角位移与脉冲的数量成正比，速度与脉冲
  的频率成正比。通常脉冲的有效宽度>=5us,频率<=125KHz。

拨码开关引脚如下表所示：

======  =========== =================
 序号      引脚名称     引脚定义
======  =========== =================
1        SW1~SW4      细分设定
2        SW5~SW8      电流设定
======  =========== =================

细分参数设置

驱动器的细分设置由拨码开关的SW1~SW4来设定，默认为100细分，一般的两相四线制步进电机的步进角都是1.8°，
因此电机旋转一圈需要360° /1.8° =200个脉冲，这里100细分转一圈 需要的脉冲数为200*100=20000个。具体详见下表：

=====  =====  =====  =====  =====   =====
 细分   脉冲    SW1    SW2    SW3     SW4 
=====  =====  =====  =====  =====   =====
  2    400      ON     ON     ON     ON
  4    800     OFF     ON     ON     ON
  8    1600     ON    OFF     ON     ON
  16   3200    OFF    OFF     ON     ON 
  32   6400     ON     ON    OFF     ON
  64   12800   OFF     ON    OFF     ON
  128  25600    ON    OFF    OFF     ON
  3    600     OFF    OFF    OFF     ON   
  6    1200     ON     ON     ON     OFF
  12   2400    OFF     ON     ON     OFF
  36   7200     ON    OFF     ON     OFF
  5    1000    OFF    OFF     ON     OFF
  10   2000     ON     ON    OFF     OFF
  20   4000    OFF     ON    OFF     OFF
  50   10000    ON    OFF    OFF     OFF  
  100  20000   OFF    OFF    OFF     OFF     
=====  =====  =====  =====  =====   =====

电流参数设置

驱动器的电流设置由拨码开关的SW5~SW8来设定，默认为1.5A。这个电流值需要根
据步进电机的额定电流来设定。一般建议驱动器的输出电流设定和电机额定电流差不多或
者小一点，详细设定见下表：


========   =====  =====  =====   =====
  电流       SW5    SW6    SW7     SW8 
========   =====  =====  =====   =====
 0.75A      OFF    OFF    OFF     ON
 1.00A      ON     OFF    OFF     ON
 1.25A      OFF    ON     OFF     ON
 1.50A      OFF    OFF    OFF     OFF 
 1.75A      OFF    OFF    ON      ON
 2.00A      ON     OFF    OFF     OFF
 2.25A      OFF    ON     ON      ON
 2.50A      OFF    ON     OFF     OFF   
 3.00A      ON     ON     OFF     OFF
 3.50A      OFF    OFF    ON      OFF
 4.00A      ON     OFF    ON      OFF
 4.50A      OFF    ON     ON      OFF
 5.00A      ON     ON     ON      OFF   
========   =====  =====  =====   =====

**接线方式**

驱动器与控制器共有两种接线方式，分别为共阴极接法和供阳极接法：

共阴极接法如图所示：

.. image:: ../media/jiefa1.png
   :align: center

共阳极接法如图所示：

.. image:: ../media/jiefa2.png
   :align: center

===========   ============= 
 驱动器引脚     电机绕组接线
===========   ============= 
    A+            蓝色
    A-            红色
    B+            绿色
    B-            黑色
===========   =============

当输入信号高于5V时，可根据需要外接限流电阻。

步进电机基础旋转控制
------------------

在本章前几个小节对步进电机的工作原理、特点以及驱动器的进行了详细的讲解，本小节将对最基本的控制方法进行例举和讲解；





硬件设计
^^^^^^^^^^^^^^^^^^^^

软件设计
^^^^^^^^^^^^^^^^^^^^

下载验证
^^^^^^^^^^^^^^^^^^^^






.. 一级标题
.. ==============================

.. 二级标题
.. ------------------

.. 三级标题
.. ^^^^^^^^^^^^^^^^^^^^^

.. 四级标题
.. """""""""""""""""

.. 五级标题
.. *****************
.. 1. hhhhhhhh
.. #. hhhhhhhh
.. #. hhhhhhhh
.. #. hhhhhhhh
.. #. hhhhhhhh
.. #. hhhhhhhh

