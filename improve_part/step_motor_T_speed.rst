.. vim: syntax=rst

步进电机梯形加减速实现
==========================================
在基础章节已经对步进电机的基础旋转进行了详细的讲解和多种方式的实验。相信你对步进电机的基础旋转已经得心应手了，
但是这并不够；还需要对步进电机的加减速进行学习，所以在这一章节主要对步进电机的梯形加减速进行讲解。

**一定会有人疑问为什么要使用加减速、加减速有什么好处呢？**

**加减速使用的场景有那些呢？**

为什么要使用加减速呢？如果你在基础部分学习，硬件驱动细分器与软件的细分参数或定时器分频参数设置不当时启动电机时，
会遇见步进电机有啸叫声但是不会转动，这是因为软件产生脉冲的频率大于步进电机的启动频率，步进电机有一个很重要的技术参数：
空载启动频率，也就是在没有负载的情况下能够正常启动的最大脉冲频率，如果脉冲频率大于该值，步进电机则不能够正常启动，
发生丢步或者堵转的情况；**或者也可以理解为由于步进脉冲变化过快，转子由于惯性的作用跟不上电信号的变化。**
所以要使用加减速来解决启动频率低的问题，在启动时使用较低的脉冲频率，然后逐渐的加快频率。

步进电机加减速使用的场景有有哪些呢？步进电机加减速使用的场景可以说是多种多样，但是大部分在一些工业上，例如CNC雕刻机、
3D打印机、车床等。只要是在工业上使用到步进电机的都会涉及到加减速，可见加减速算法的重要性。



梯形加减速算法原理详解
------------------------------------

梯形加减速的实现是基于基础旋转章节的内容，
所以对于基础旋转章节不理解的可以参考，**基础部分步进电机基础旋转控制**
章节。参考书目《AVR446_Linear speed control of stepper motor.pdf》

算法特点
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

为了使得不出现丢步或者超步现象并且提高效率，需要使得步进电机先以固定的加速度达到目标速度，然后以这个速度运行，
快到达目标步数时再减到最低速；整个过程是一个梯形的模型，所以以它的数学模型命名的加减速算法。

.. image:: ../media/步进电机梯形模型.png
   :align: center
   :alt: 梯形加减速基本数学模型

从模型中即可反映出算法的特点，数学模型中一共分为三个阶段，OA加速部分、AB匀速部分和BC减速部分。

- 在OA加速过程中，由低于步进电机的启动频率开始启动（模型中由0启动），以固定的加速度增加速度到目标值；
- 在AB匀速过程中，以最大速度匀速运动；
- 在BC减速部分中，以加速度不变的速度递减到0；

这种算法是一种在加速过程和减速过程中加速度不变的匀变速控制算法，
由于速度变化的曲线有折点，所以在启动、停止、匀速段中很容易产生冲击和振动。

算法基础概念及方程
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

步进电机的转动需要控制器发送脉冲，如果控制器以恒定速度发送脉冲，那么步进电机就以恒定速度转动；
如果控制器以加速度运动，那么步进电机就以加速度运动；所以只要改变脉冲的频率就可以改变速度的变化，
也就是说调整脉冲之间的时间间隔就可以改变速度。

.. image:: ../media/step_pluse.png
   :align: center

上图为步进电机与时间的示意图，其中

- t0  表示脉冲发送的起始时刻
- t1  表示脉冲发送的第二个时刻
- t2  表示脉冲发送的第三个时刻
- tt  表示定时器的计数周期
- c0  表示定时器从t0~t1时刻的定时器计数值
- c1  表示定时器从t1~t2时刻的定时器计数值
- δt  表示两个脉冲之间的间隔时间

以stm32的高级定时器8为例，定时器8的时钟频率为168MHZ,如果将分频值设置为5，那么定时器的时钟频率则为：**ft=168/(5+1)=28MHZ**,
相当于计数28M次正好为一秒，周期与频率为倒数关系，所以分频值为5的定时器8的计数周期为:**1/ft**;

.. image:: ../media/基础公式1.png
   :align: center

其中 :

- n 为步进电机所转的脉冲数
- s 为时间单位 秒
- spr 为步进电机所转一圈的脉冲数
- rad 为弧度单位 (1rad = (180/π)° ≈ 57.3°)
- rad/sec 弧度每秒；
  1圈（revolutions） = 2 * 3.1415弧度（rad）；
  (1 rad/sec = 60*1/(2*3.1415) rev/min = 9.55 rpm)；
  1 rad/sec=9.55 rpm；

直线加减速模型解析
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

在本章的一开始就已经简单的介绍了一下加减速算法的模型

**模型阶段分析：**

.. image:: ../media/直线模型.png
   :align: center  

要使得步进电机平稳的启动和停止，则需要控制好步进电机的加速度和减速度，控制好加速度和减速度就可得到好的曲线模型，
上图中一共是三个不同变量与时间的变化曲线，分别是 **加速度与时间、速度与时间和位置与时间的曲线**。

在三个模型中的跳变位置已经画上对应的虚线，分别为虚线a、虚线b、虚线c和虚线d

1. **起始点~a**：在这阶段中，速度、加速度、位置都没有变化；
#. **a~b阶段**：从虚线a开始，在这阶段中加速度不变，速度与位置不断上升，并且速度是以恒定加速度上升，上升到最大速度也就是速度曲线与虚线b的交点；
#. **b~c阶段**：在这阶段中，以不变的速度在运行，由于速度不变，则加速度为零，并且位置在这阶段呈现一个一次函数的上升阶段；
#. **c~d阶段**：在这阶段中，速度开始呈匀减速的状态，所以加速度为负值，但是位置依旧上升，但上升曲线逐渐变慢；


**进一步理解：**

在已经对模型的几个阶段有所了解后，下面对加速部分进一步讲解；

.. image:: ../media/速度时间脉冲位置.png
   :align: center     

上图中分别是对 **ω-t和θ-t** 的变化图：

在 **ω-t** 图中是梯形加减速模型中的加速部分中，红色竖线表示的是脉冲发生的位置，由加速的方向看（从左到右），
在图上两个相邻之间的脉冲之间的距离越来越近，根据 **δt=ct** 计数周期不变，计数值越来越小也就意味着脉冲之间的间隔时间变短了，
频率变快了，直接影响步进电机转的变快了；

在 **θ-t** 图中，脉冲每产生一次就对应着θ轴上的一小格，**ω-t** 图中工产生6次脉冲就对应 **θ-t** 中的6次位置的变化。


脉冲时间间隔的精确计算
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^








.. 一级标题
.. ==============================

.. 二级标题
.. ------------------

.. 三级标题
.. ^^^^^^^^^^^^^^^^^^^^^

.. 四级标题
.. """""""""""""""""

.. 五级标题
.. *****************
.. 1. hhhhhhhh
.. #. hhhhhhhh
.. #. hhhhhhhh
.. #. hhhhhhhh
.. #. hhhhhhhh
.. #. hhhhhhhh

.. .. image:: ../media/xxx.png
..    :align: center
..    :alt: xxx

.. .. code-block:: c
..     :caption: xxx
..     :linenos:


.. .. _test:
..  :ref:`test` 



