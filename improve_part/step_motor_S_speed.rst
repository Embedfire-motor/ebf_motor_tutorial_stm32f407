.. vim: syntax=rst

步进电机S形加减速实现
==========================================

在上一章节已经对步进电机的梯形加减速进行了非常详细的推导和讲解，接下来会对另一种加减速进行讲解—S形加减速。

S形加减速可以理解为在加减速的变化过程中速度曲线呈现一个英文字母“S”形的加减速算法。那么已经有了梯形加减速算法了，
为什么还需要S形加减速算法呢？答案很明显，由于不同的加减速算法的特点是不一样的，所以带来的效果自然而然的就不同了。

**梯形加减速** 在启动、停止和高速运动的过程中会产生很大的冲击力振动和噪声，所以多数会应用于简单的定长送料的应用场合中，
例如常见的3D打印机使用的就是梯形加减速算法；但是相比较 **S形加减速** 在启动停止以及高速运动时的速度变化的比较慢，
导致冲击力噪音就很小，但这也决定了他在启动停止时需要较长的时间，所以多数适用于精密的工件搬运与建造。


S形加减速原理分析
------------------------------------

"S"模型解析
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

S形加减速算法对于曲线并没有具体的限定和轨迹，可以是指数函数、正弦函数只要满足于速度的变化曲线是一个“S”形即可；

.. image:: ../media/S加减速图1.png
   :align: center

具体的曲线情况如上图。在上图中一共有两幅曲线图像，其中红色的是速度的曲线，可以看出整体都属于速度的上升阶段，
在加速的过程中一共可以分为两个阶段，分别为前半部分和后半部分，前半部分是加速度匀速递增的曲线，称为：
**加加速阶段** 曲线，后半部分是加速度匀速递减的曲线超，所以称为： **减加速度阶段** 曲线。

上图中蓝色的曲线是加速度的变化曲线，按照速度变化的规律共分成前半段加速度匀速递增和后半部分加速度匀速递减，
也可以简单理解为一次函数，前半段一次函数的斜率是大于0的，后半部分的斜率是小于0的；加速度从0开始变化，
到了最大值开始减小，最后为0，由于加速度的斜率是相同的，所以斜率大于0和小于0两段曲线是关于加速度最大值所对应的速度中心对称的。

算法理论实现
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

下图共有三条曲线分别是红色、青色和蓝色，其中红色速度曲线、蓝色加速度曲线，青色为梯形加减速模型的加速部分曲线。

.. image:: ../media/对比图2.png
   :align: center

图中是梯形加速度部分（青色曲线）和S形加速部分（红色曲线）比较，梯形加减速是按照一个固定的斜率增加速度到达Vt,
到达Vt后加速部分结束，开始进入匀速部分，梯形加减速由匀加速上升的趋势突然变成匀速，由于惯性会产生较大的冲击力和噪声；
S形加减速则很好的避免了这一问题，在加速到Vt后进入匀速阶段曲线上非常的顺滑，阶段衔接的相对完美。

主要的目的是通过初速度、末速度和时间三个变量计算出控制步进电机的每一步速度；

**基础公式推导**

加速度 **a** 从0变化到最大值有

.. image:: ../media/加速度a公式.png
   :align: center

其中 **k** 是图中加速度的斜率，**t** 为时间变化，所以有：

.. image:: ../media/速度与加速度公式.png
   :align: center

对加速度积分就可以得到速度，所以有：

.. image:: ../media/对加速度积分.png
   :align: center

根据公式三可得：

.. image:: ../media/速度公式.png
   :align: center

如上图所示：当 **加速度a** 随着时间变化到最大值时速度 **V=Vm**,并且初速度 **V0=0**，将这两个条件带入公式4，
可求得 **斜率k**:

.. image:: ../media/斜率公式.png
   :align: center

对速度积分就可以得到位移，所以有：

.. image:: ../media/速度积分获得位移.png
   :align: center

**其中：**

1. 对速度进行积分；
#. 将 **速度v** 的表达式带入；
#. 求解速度积分的计算结果，并得到位移与时间的公式，即 **公式6**；

根据 **公式六** 可以很清楚的看到只要给定一个合适的t值，
比如1秒内加速1000次，也就是 **t1=1/1000** 那就可以得到一个比较平滑的速度曲线。

**速度推导**

步进电机的速度是由定时器脉冲的频率决定的，频率越快也就是步进电机的速度越快，
所以可以得出 **脉冲输出的频率=速度**，所以有：

.. image:: ../media/速度与周期的关系.png
   :align: center

所以说只要计算出第一步的周期时间就可以计算出下一步的速度；并且根据时间的变化每计算一次就会累加一次时间变化量 **Sumt**。

在上图中：

- **T 代表但脉冲周期**
- **f 代表频率**
- **speed 代表速度**

每一步的速度都是在初始速度的基础上计算的，所以说 **公式4** 计算的是当 **初始速度为0时** 的增量，具体公式如下：

.. image:: ../media/每一时刻的速度推导.png
   :align: center

1. t时刻的速度等于初始速度与增量速度的和；
#. 求解增量速度，并且将累计时间变量带入 **公式4**；
#. 带入求解t时刻的速度；



S形加减速算法实现
------------------------------------




.. 一级标题
.. ==============================

.. 二级标题
.. ------------------

.. 三级标题
.. ^^^^^^^^^^^^^^^^^^^^^
     
.. 四级标题
.. """""""""""""""""

.. 五级标题
.. *****************
.. 1. hhhhhhhh
.. #. hhhhhhhh
.. #. hhhhhhhh

.. .. image:: ../media/xxx.png
..    :align: center
..    :alt: xxx

.. .. code-block:: c
..     :caption: xxx
..     :linenos:

.. .. _test:
..  :ref:`test` 















