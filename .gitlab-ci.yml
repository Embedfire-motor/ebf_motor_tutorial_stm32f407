variables:
  #要上传的PDF仓库地址，注意格式，取http:// 后的部分
  GIT_ADDRESS: EmbedfireNAS:30000/learning/git/autoupdate-test.git
  #gitlab 邮箱
  GIT_USEREMAIL: hjw0415@outlook.com
  #gitlab 用户名
  GIT_USERNAME: hejiawen
  #GIT_PASSWORD在CI/CD->Variables中定义变量，警告，不可在本文件中定义明文密码
  #GIT_PASSWORD


stages: # 分段
  - install
  - build
  - deploy
  
cache: # 缓存
  paths:
    - _build

install-job:
  tags:
    - pdf
  stage: install
  script:
    #删除以前的缓存文件
    - make clean
    #rst转latex文件
    #- sphinx-build -b latex -D language=en -d _build/doctrees . _build/latex
    - make latex

build-job:
  tags:
    - pdf
  stage: build
  script:
  #复制相关资源文件
    - cp -r latexfile/*  _build/latex/  
  #使用python脚本处理latex文件
    - python3 latexbuild.py
  #latex文件生成pdf
    - cd _build/latex/ && latexmk -r latexmkrc -pdf -f -dvi- -ps-  -interaction=nonstopmode
  #允许带错误运行下一步
  #allow_failure: true

PDF-files:
  tags:
    - pdf
  stage: deploy
  script:
    #修改文件名称
    - python3 latexbuild2.py 
    #移动文件到指定位置 
    - cp _build/latex/*.pdf ./

    #网盘同步，在不同的仓库中都需要修改
    #F103拂晓
    - find /home/flyleaf/ebf_nas/公司共享/百度云对外发布资料/STM32产品线/STM32电机系列/野火【F103开发板-拂晓】光盘资料/A盘（资料盘）/1-程序源码_教程文档/6-[野火]《电机应用开发实战指南—基于STM32》/ -name "*.pdf" -print0 | xargs -0 rm
    - cp _build/latex/*.pdf /home/flyleaf/ebf_nas/公司共享/百度云对外发布资料/STM32产品线/STM32电机系列/野火【F103开发板-拂晓】光盘资料/A盘（资料盘）/1-程序源码_教程文档/6-[野火]《电机应用开发实战指南—基于STM32》/
    #F407骄阳
    - find /home/flyleaf/ebf_nas/公司共享/百度云对外发布资料/STM32产品线/STM32电机系列/野火【F407开发板-骄阳】光盘资料/A盘（资料盘）/1-程序源码_教程文档/8-[野火]《电机应用开发实战指南—基于STM32》/ -name "*.pdf" -print0 | xargs -0 rm
    - cp _build/latex/*.pdf /home/flyleaf/ebf_nas/公司共享/百度云对外发布资料/STM32产品线/STM32电机系列/野火【F407开发板-骄阳】光盘资料/A盘（资料盘）/1-程序源码_教程文档/8-[野火]《电机应用开发实战指南—基于STM32》//
    #H743繁星
    - find /home/flyleaf/ebf_nas/公司共享/百度云对外发布资料/STM32产品线/STM32电机系列/野火【H743开发板-繁星】光盘资料/A盘（资料盘）/1-程序源码_教程文档/8-[野火]《电机应用开发实战指南—基于STM32》/ -name "*.pdf" -print0 | xargs -0 rm
    - cp _build/latex/*.pdf /home/flyleaf/ebf_nas/公司共享/百度云对外发布资料/STM32产品线/STM32电机系列/野火【H743开发板-繁星】光盘资料/A盘（资料盘）/1-程序源码_教程文档/8-[野火]《电机应用开发实战指南—基于STM32》/

    #上传到gitlab PDF文档仓库
    #克隆仓库
    - git clone http://$GIT_USERNAME:$GIT_PASSWORD@$GIT_ADDRESS /docs/workdir
    #修改复制pdf文件到拉取的git仓库
    - cd _build/latex/ && rename 's/\.pdf/.pdf_bak/' *.pdf 
    - cp ./*.pdf_bak /docs/workdir/
    - cd /docs/workdir/
    #git设置
    - git config --global user.email "$GIT_USEREMAIL"
    - git config --global user.name "$GIT_USERNAME"
    #从git删除原来的pdf文件，并将新文件添加
    - git rm *.pdf
    - rename   's/\.pdf_bak/.pdf/'  *.pdf_bak 
    - git add *.pdf 
    #提交推送
    - git commit -m "gitlab-ci自动提交"
    - git push

  artifacts:
    name: 'PDFfile' #下载压缩包文件名
    paths: #文件路径
      - ./*.pdf
    expire_in: 1 day #保存时间
    when: on_success #仅在job成功后上传
